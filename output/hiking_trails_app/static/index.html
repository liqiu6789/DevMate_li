<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¾’æ­¥è·¯çº¿æ¢ç´¢è€… - å‘ç°é™„è¿‘çš„å¾’æ­¥è·¯çº¿</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: linear-gradient(90deg, #2c3e50, #3498db);
            color: white;
            padding: 2rem 0;
            border-radius: 10px;
            margin-bottom: 2rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }

        h1 {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }

        .subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .controls {
            background: white;
            padding: 1.5rem;
            border-radius: 10px;
            margin-bottom: 2rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .filter-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .filter-item {
            display: flex;
            flex-direction: column;
        }

        label {
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #2c3e50;
        }

        select, input {
            padding: 0.75rem;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        select:focus, input:focus {
            outline: none;
            border-color: #3498db;
        }

        .button-group {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        button {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 5px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .primary-btn {
            background: #3498db;
            color: white;
        }

        .primary-btn:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }

        .secondary-btn {
            background: #2ecc71;
            color: white;
        }

        .secondary-btn:hover {
            background: #27ae60;
            transform: translateY(-2px);
        }

        .location-info {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 1rem;
            border-radius: 5px;
            margin-top: 1rem;
            display: none;
        }

        .trails-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 2rem;
            margin-top: 2rem;
        }

        .trail-card {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .trail-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }

        .trail-image {
            width: 100%;
            height: 200px;
            object-fit: cover;
        }

        .trail-content {
            padding: 1.5rem;
        }

        .trail-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 1rem;
        }

        .trail-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #2c3e50;
        }

        .difficulty-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .difficulty-easy {
            background: #d4edda;
            color: #155724;
        }

        .difficulty-medium {
            background: #fff3cd;
            color: #856404;
        }

        .difficulty-hard {
            background: #f8d7da;
            color: #721c24;
        }

        .trail-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin: 1rem 0;
            padding: 1rem 0;
            border-top: 1px solid #eee;
            border-bottom: 1px solid #eee;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 1.2rem;
            font-weight: 600;
            color: #3498db;
        }

        .stat-label {
            font-size: 0.85rem;
            color: #7f8c8d;
        }

        .trail-features {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin: 1rem 0;
        }

        .feature-tag {
            background: #ecf0f1;
            padding: 0.25rem 0.75rem;
            border-radius: 15px;
            font-size: 0.85rem;
            color: #2c3e50;
        }

        .trail-description {
            color: #666;
            margin: 1rem 0;
            line-height: 1.5;
        }

        .rating {
            color: #f39c12;
            font-weight: 600;
        }

        .loading {
            text-align: center;
            padding: 3rem;
            font-size: 1.2rem;
            color: #7f8c8d;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 1rem;
            border-radius: 5px;
            margin: 1rem 0;
            display: none;
        }

        footer {
            text-align: center;
            margin-top: 3rem;
            padding: 2rem 0;
            color: #7f8c8d;
            border-top: 1px solid #eee;
        }

        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                text-align: center;
                gap: 1rem;
            }
            
            .trails-grid {
                grid-template-columns: 1fr;
            }
            
            .filter-group {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-content">
                <div>
                    <h1>ğŸš¶â€â™‚ï¸ å¾’æ­¥è·¯çº¿æ¢ç´¢è€…</h1>
                    <p class="subtitle">å‘ç°æ‚¨é™„è¿‘çš„ç²¾å½©å¾’æ­¥è·¯çº¿ï¼Œå¼€å§‹æ‚¨çš„æˆ·å¤–å†’é™©ï¼</p>
                </div>
                <div class="stats-display">
                    <div id="stats-info">æ­£åœ¨åŠ è½½ç»Ÿè®¡ä¿¡æ¯...</div>
                </div>
            </div>
        </header>

        <div class="controls">
            <div class="filter-group">
                <div class="filter-item">
                    <label for="distanceFilter">æœ€å¤§è·ç¦» (å…¬é‡Œ)</label>
                    <input type="range" id="distanceFilter" min="5" max="100" value="50" step="5">
                    <span id="distanceValue">50 å…¬é‡Œ</span>
                </div>
                
                <div class="filter-item">
                    <label for="difficultyFilter">éš¾åº¦çº§åˆ«</label>
                    <select id="difficultyFilter">
                        <option value="">å…¨éƒ¨éš¾åº¦</option>
                        <option value="easy">ç®€å•</option>
                        <option value="medium">ä¸­ç­‰</option>
                        <option value="hard">å›°éš¾</option>
                    </select>
                </div>
                
                <div class="filter-item">
                    <label for="sortFilter">æ’åºæ–¹å¼</label>
                    <select id="sortFilter">
                        <option value="distance">è·ç¦»æœ€è¿‘</option>
                        <option value="rating">è¯„åˆ†æœ€é«˜</option>
                        <option value="distance_km">è·¯çº¿æœ€é•¿</option>
                    </select>
                </div>
            </div>

            <div class="button-group">
                <button class="primary-btn" onclick="getCurrentLocation()">
                    ğŸ“ ä½¿ç”¨æˆ‘çš„å½“å‰ä½ç½®
                </button>
                <button class="secondary-btn" onclick="loadTrails()">
                    ğŸ”„ åˆ·æ–°è·¯çº¿
                </button>
                <button onclick="showManualLocation()">
                    ğŸ—ºï¸ æ‰‹åŠ¨è®¾ç½®ä½ç½®
                </button>
            </div>

            <div class="location-info" id="locationInfo">
                <p>å½“å‰ä½ç½®: <span id="currentLocation">æ­£åœ¨è·å–ä½ç½®...</span></p>
                <p>æ‰¾åˆ° <span id="trailCount">0</span> æ¡è·¯çº¿</p>
            </div>
        </div>

        <div class="error" id="errorMessage"></div>

        <div class="loading" id="loadingMessage">
            â³ æ­£åœ¨åŠ è½½å¾’æ­¥è·¯çº¿...
        </div>

        <div class="trails-grid" id="trailsContainer">
            <!-- è·¯çº¿å¡ç‰‡å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
        </div>

        <footer>
            <p>Â© 2024 å¾’æ­¥è·¯çº¿æ¢ç´¢è€… | ä½¿ç”¨ FastAPI + åŸç”Ÿ JavaScript æ„å»º</p>
            <p>éµå¾ªå†…éƒ¨å¼€å‘è§„èŒƒ - å¿«ä¹ç¼–ç ï¼ ğŸ˜Š</p>
        </footer>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let currentLocation = { lat: 40.7128, lng: -74.0060 }; // é»˜è®¤çº½çº¦
        let trails = [];
        let isLoading = false;

        // DOMå…ƒç´ 
        const trailsContainer = document.getElementById('trailsContainer');
        const loadingMessage = document.getElementById('loadingMessage');
        const errorMessage = document.getElementById('errorMessage');
        const locationInfo = document.getElementById('locationInfo');
        const currentLocationSpan = document.getElementById('currentLocation');
        const trailCountSpan = document.getElementById('trailCount');
        const distanceFilter = document.getElementById('distanceFilter');
        const distanceValue = document.getElementById('distanceValue');
        const statsInfo = document.getElementById('stats-info');

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // è®¾ç½®è·ç¦»ç­›é€‰å™¨äº‹ä»¶
            distanceFilter.addEventListener('input', function() {
                distanceValue.textContent = this.value + ' å…¬é‡Œ';
            });
            
            // åŠ è½½åˆå§‹æ•°æ®
            loadTrails();
            loadStats();
            
            // è®¾ç½®ç­›é€‰å™¨å˜åŒ–äº‹ä»¶
            document.getElementById('difficultyFilter').addEventListener('change', loadTrails);
            document.getElementById('sortFilter').addEventListener('change', sortTrails);
            distanceFilter.addEventListener('change', loadTrails);
        });

        // è·å–å½“å‰ä½ç½®
        function getCurrentLocation() {
            if (!navigator.geolocation) {
                showError('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒåœ°ç†ä½ç½®åŠŸèƒ½');
                return;
            }

            showLoading('æ­£åœ¨è·å–æ‚¨çš„ä½ç½®...');
            
            navigator.geolocation.getCurrentPosition(
                function(position) {
                    currentLocation = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };
                    
                    // æ›´æ–°ä½ç½®åˆ°æœåŠ¡å™¨
                    updateServerLocation();
                    loadTrails();
                },
                function(error) {
                    showError('æ— æ³•è·å–æ‚¨çš„ä½ç½®: ' + error.message);
                    hideLoading();
                }
            );
        }

        // æ›´æ–°æœåŠ¡å™¨ä½ç½®
        async function updateServerLocation() {
            try {
                const response = await fetch('/api/location', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(currentLocation)
                });
                
                const data = await response.json();
                console.log('ä½ç½®æ›´æ–°æˆåŠŸ:', data);
            } catch (error) {
                console.error('ä½ç½®æ›´æ–°å¤±è´¥:', error);
            }
        }

        // åŠ è½½å¾’æ­¥è·¯çº¿
        async function loadTrails() {
            if (isLoading) return;
            
            isLoading = true;
            showLoading('æ­£åœ¨æœç´¢é™„è¿‘çš„å¾’æ­¥è·¯çº¿...');
            hideError();
            
            try {
                const maxDistance = distanceFilter.value;
                const difficulty = document.getElementById('difficultyFilter').value;
                
                let url = `/api/trails?max_distance_km=${maxDistance}`;
                if (difficulty) {
                    url += `&difficulty=${difficulty}`;
                }
                if (currentLocation.lat && currentLocation.lng) {
                    url += `&lat=${currentLocation.lat}&lng=${currentLocation.lng}`;
                }
                
                const response = await fetch(url);
                const data = await response.json();
                
                // æ£€æŸ¥å“åº”æ˜¯å¦åŒ…å« happiness_level
                if (!data.happiness_level) {
                    throw new Error('APIå“åº”ä¸ç¬¦åˆè§„èŒƒ');
                }
                
                trails = data.trails;
                currentLocation = data.user_location;
                
                // æ›´æ–°UI
                updateLocationInfo();
                renderTrails();
                sortTrails();
                
            } catch (error) {
                showError('åŠ è½½è·¯çº¿å¤±è´¥: ' + error.message);
                console.error('Error:', error);
            } finally {
                isLoading = false;
                hideLoading();
            }
        }

        // åŠ è½½ç»Ÿè®¡ä¿¡æ¯
        async function loadStats() {
            try {
                const response = await fetch('/api/stats');
                const data = await response.json();
                
                if (data.happiness_level === 'max') {
                    statsInfo.innerHTML = `
                        <strong>${data.total_trails}</strong> æ¡è·¯çº¿å¯ç”¨ | 
                        è®¿é—®æ¬¡æ•°: <strong>${data.app_counter}</strong>
                    `;
                }
            } catch (error) {
                console.error('åŠ è½½ç»Ÿè®¡ä¿¡æ¯å¤±è´¥:', error);
            }
        }

        // æ¸²æŸ“è·¯çº¿å¡ç‰‡
        function renderTrails() {
            if (trails.length === 0) {
                trailsContainer.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 3rem;">
                        <h3>æœªæ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„å¾’æ­¥è·¯çº¿</h3>
                        <p>å°è¯•è°ƒæ•´ç­›é€‰æ¡ä»¶æˆ–æ›´æ”¹ä½ç½®</p>
                    </div>
                `;
                return;
            }
            
            trailsContainer.innerHTML = trails.map(trail => `
                <div class="trail-card">
                    <img src="${trail.image_url || 'https://images.unsplash.com/photo-1551632811-561732d1e306?w=800'}" 
                         alt="${trail.name}" 
                         class="trail-image"
                         onerror="this.src='https://images.unsplash.com/photo-1551632811-561732d1e306?w=800'">
                    
                    <div class="trail-content">
                        <div class="trail-header">
                            <h3 class="trail-title">${trail.name}</h3>
                            <span class="difficulty-badge difficulty-${trail.difficulty}">
                                ${getDifficultyText(trail.difficulty)}
                            </span>
                        </div>
                        
                        <div class="trail-stats">
                            <div class="stat-item">
                                <div class="stat-value">${trail.distance_km}km</div>
                                <div class="stat-label">è·ç¦»</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value">${trail.estimated_time_hours}h</div>
                                <div class="stat-label">æ—¶é—´</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value">${trail.distance_from_user_km || '?'}km</div>
                                <div class="stat-label">è·æ‚¨</div>
                            </div>
                        </div>
                        
                        <div class="trail-description">
                            ${trail.description}
                        </div>
                        
                        <div class="trail-features">
                            ${trail.features.map(feature => `
                                <span class="feature-tag">${feature}</span>
                            `).join('')}
                        </div>
                        
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 1rem;">
                            <div class="rating">
                                â­ ${trail.rating}/5.0
                            </div>
                            <button onclick="viewTrailDetail(${trail.id})" 
                                    style="background: #3498db; color: white; border: none; padding: 0.5rem 1rem; border-radius: 5px; cursor: pointer;">
                                æŸ¥çœ‹è¯¦æƒ…
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // æ’åºè·¯çº¿
        function sortTrails() {
            const sortBy = document.getElementById('sortFilter').value;
            
            if (sortBy === 'distance') {
                trails.sort((a, b) => (a.distance_from_user_km || 999) - (b.distance_from_user_km || 999));
            } else if (sortBy === 'rating') {
                trails.sort((a, b) => b.rating - a.rating);
            } else if (sortBy === 'distance_km') {
                trails.sort((a, b) => b.distance_km - a.distance_km);
            }
            
            renderTrails();
        }

        // æŸ¥çœ‹è·¯çº¿è¯¦æƒ…
        function viewTrailDetail(trailId) {
            alert(`æŸ¥çœ‹è·¯çº¿ #${trailId} çš„è¯¦ç»†ä¿¡æ¯\nåŠŸèƒ½å¼€å‘ä¸­...`);
            // å®é™…åº”ç”¨ä¸­è¿™é‡Œä¼šè·³è½¬åˆ°è¯¦æƒ…é¡µé¢æˆ–æ˜¾ç¤ºæ¨¡æ€æ¡†
        }

        // æ‰‹åŠ¨è®¾ç½®ä½ç½®
        function showManualLocation() {
            const lat = prompt('è¯·è¾“å…¥çº¬åº¦ (ä¾‹å¦‚: 40.7128):', currentLocation.lat);
            const lng = prompt('è¯·è¾“å…¥ç»åº¦ (ä¾‹å¦‚: -74.0060):', currentLocation.lng);
            
            if (lat && lng) {
                currentLocation = {
                    lat: parseFloat(lat),
                    lng: parseFloat(lng)
                };
                
                updateServerLocation();
                loadTrails();
            }
        }

        // æ›´æ–°ä½ç½®ä¿¡æ¯æ˜¾ç¤º
        function updateLocationInfo() {
            currentLocationSpan.textContent = 
                `çº¬åº¦: ${currentLocation.lat.toFixed(4)}, ç»åº¦: ${currentLocation.lng.toFixed(4)}`;
            trailCountSpan.textContent = trails.length;
            locationInfo.style.display = 'block';
        }

        // å·¥å…·å‡½æ•°
        function getDifficultyText(difficulty) {
            const map = {
                'easy': 'ç®€å•',
                'medium': 'ä¸­ç­‰', 
                'hard': 'å›°éš¾'
            };
            return map[difficulty] || difficulty;
        }

        function showLoading(message) {
            loadingMessage.textContent = message;
            loadingMessage.style.display = 'block';
            trailsContainer.style.opacity = '0.5';
        }

        function hideLoading() {
            loadingMessage.style.display = 'none';
            trailsContainer.style.opacity = '1';
        }

        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
        }

        function hideError() {
            errorMessage.style.display = 'none';
        }

        // å®šæœŸåˆ·æ–°ç»Ÿè®¡ä¿¡æ¯
        setInterval(loadStats, 30000);
    </script>
</body>
</html>